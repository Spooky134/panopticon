<!DOCTYPE html>
<html>
<head>
    <title>Video Stream {{ stream_id }}</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
    <h1>Video Stream: {{ stream_id }}</h1>

    <div id="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="status">Connecting...</div>

    <script>
        const streamId = "{{ stream_id }}";
        const fastapiWsUrl = "{{ fastapi_ws_url }}";

        let peerConnection;
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');

        // WebRTC конфигурация (STUN серверы)
        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        async function connectToStream() {
            try {
                statusDiv.textContent = 'Creating WebRTC connection...';

                // Создаем WebSocket соединение с FastAPI сервисом
                const ws = new WebSocket(`${fastapiWsUrl}/ws/stream/${streamId}`);

                ws.onopen = () => {
                    statusDiv.textContent = 'Connected to stream service';
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    statusDiv.textContent = 'Connection error';
                };

                // Создаем PeerConnection
                peerConnection = new RTCPeerConnection(configuration);

                // Обрабатываем входящие видеоданные
                peerConnection.ontrack = (event) => {
                    console.log('Received remote stream');
                    remoteVideo.srcObject = event.streams[0];
                    statusDiv.textContent = 'Stream connected';
                };

                // Обрабатываем ICE кандидаты
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'ice_candidate',
                            candidate: event.candidate
                        }));
                    }
                };

                // Обрабатываем сообщения от сервера
                ws.onmessage = async (event) => {
                    const message = JSON.parse(event.data);

                    switch (message.type) {
                        case 'offer':
                            await peerConnection.setRemoteDescription(
                                new RTCSessionDescription(message.offer)
                            );

                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);

                            ws.send(JSON.stringify({
                                type: 'answer',
                                answer: answer
                            }));
                            break;

                        case 'ice_candidate':
                            await peerConnection.addIceCandidate(
                                new RTCIceCandidate(message.candidate)
                            );
                            break;

                        case 'error':
                            console.error('Server error:', message.error);
                            statusDiv.textContent = `Error: ${message.error}`;
                            break;
                    }
                };

            } catch (error) {
                console.error('Connection failed:', error);
                statusDiv.textContent = 'Connection failed';
            }
        }

        // Запускаем подключение при загрузке страницы
        connectToStream();
    </script>
</body>
</html>